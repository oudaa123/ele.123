<script defer>
const SCRIPT_PRODUCTS_URL = "https://script.google.com/macros/s/AKfycbxW3_pcjSfffMTLZefZpzFIrbhijiaWY_u_4ZAmXEV2O04SMN5zplucKnAugWWbP8zzmA/exec";
const container = document.getElementById("products-container");
let productsData = [];
let cart = JSON.parse(localStorage.getItem("cart")) || [];

// حفظ السلة تلقائياً
function saveCart() {
  localStorage.setItem("cart", JSON.stringify(cart));
}

// عرض المنتجات
function renderProducts(data){
  let html = "";
  for(let i=0;i<data.length;i++){
      const item = data[i];
      html += `<div class="product">
                  <img src="${item.image || 'https://via.placeholder.com/150'}">
                  <div class="product-info">
                    <div class="name">${item.name}</div>
                    <div class="price">${item.price} جنيه</div>
                    <input type="number" min="1" value="1" data-index="${i}">
                    <button onclick="addToCart(${i})">أضف إلى السلة</button>
                  </div>
               </div>`;
  }
  container.innerHTML = html;
}

// تحميل سريع للمنتجات
(async function(){
   if(localStorage.getItem("products")){
      productsData = JSON.parse(localStorage.getItem("products"));
      renderProducts(productsData);
   }
   try {
     const res = await fetch(SCRIPT_PRODUCTS_URL, {cache:"no-store"});
     const data = await res.json();
     productsData = data.reverse();
     localStorage.setItem("products", JSON.stringify(productsData));
     renderProducts(productsData);
     setTimeout(checkNewProducts, 1500);
   } catch(err){ console.log("❌ خطأ في جلب المنتجات:",err); }
})();

function showToast(msg){
  const toast = document.getElementById("toast");
  toast.innerText = msg;
  toast.style.display = "block";
  setTimeout(()=>toast.style.display="none",1200);
}

// تحديث عداد السلة ووضعه فوق الزر
function updateCartCount(){
  const count = cart.reduce((sum, qty)=> qty ? sum+qty : sum, 0);
  const badge = document.getElementById("cart-count");
  badge.style.display = count>0?"inline-block":"none";
  badge.innerText = count;
}

// إضافة منتج للسلة
function addToCart(index){
  const input = container.querySelector(`input[data-index='${index}']`);
  const quantity = parseInt(input.value);
  if(quantity<=0) return;
  cart[index] = (cart[index] || 0) + quantity;
  updateCartCount();
  saveCart();
  showToast(`${productsData[index].name} تم إضافته/تحديثه في السلة`);
}

// عرض إجمالي الفاتورة
function showTotal(){
  let total=0;
  const cartList=document.getElementById("cartList");
  cartList.innerHTML="";
  cart.forEach((qty,idx)=>{
    if(qty){
      const price = productsData[idx].price;
      const lineTotal = qty*price;
      total+=lineTotal;
      const div=document.createElement("div");
      div.className="cart-item";
      div.innerHTML=`<span>${productsData[idx].name}</span>
                     <span>الكمية: <input type="number" min="1" value="${qty}" style="width:50px;" onchange="updateQty(${idx},this.value)"></span>
                     <span>السعر: ${price}</span>
                     <span>الإجمالي: ${lineTotal}</span>
                     <span><button class="remove-btn" onclick="removeItem(${idx})">حذف</button></span>`;
      cartList.appendChild(div);
    }
  });
  document.getElementById("totalAmount").innerText=total;
  document.getElementById("totalModal").style.display="block";
}

// تحديث كمية عنصر في السلة
function updateQty(idx,value){ 
  value=parseInt(value); 
  if(value<=0) delete cart[idx]; 
  else cart[idx]=value; 
  updateCartCount(); 
  saveCart();
  showTotal(); 
}

// إزالة عنصر من السلة
function removeItem(idx){ 
  delete cart[idx]; 
  updateCartCount(); 
  saveCart();
  showTotal(); 
}

function closeTotalModal(){ document.getElementById("totalModal").style.display='none'; }

// إرسال الطلب عبر واتساب
document.getElementById("sendBtn").onclick = function(){
  const orderDiv = document.getElementById("orderNumbers");
  orderDiv.style.display="block";
  orderDiv.querySelectorAll("a").forEach(a=>{
    a.onclick=(e)=>{
      e.preventDefault();
      let text="🧾 طلبية جديدة\n\n";
      let total=0;
      cart.forEach((qty,idx)=>{
        if(qty){
          const price=productsData[idx].price;
          const lineTotal=qty*price;
          total+=lineTotal;
          text+=`${productsData[idx].name} | ${qty} | ${price} | ${lineTotal}\n`;
        }
      });
      text+=`المجموع الكلي: ${total} جنيه`;
      window.open(`${a.href}?text=${encodeURIComponent(text)}`,"_blank");
    }
  });
}

document.getElementById("cartBtn").onclick=showTotal;
document.getElementById("totalBtn").onclick=showTotal;
document.getElementById("supportBtn").onclick=()=>window.open("https://wa.me/201022495795","_blank");

// فحص المنتجات الجديدة
function checkNewProducts(){
  const today=(new Date()).toISOString().split("T")[0];
  let newCount=0;
  productsData.forEach(p=>{ if(p.date&&p.date.startsWith(today)) newCount++; });
  if(newCount>0){
    document.getElementById("notif-count").innerText=newCount;
    document.getElementById("notif-count").style.display="inline-block";
    document.getElementById("newBanner").style.display="block";
    let audio=new Audio("https://www.soundjay.com/buttons/sounds/button-3.mp3"); audio.play();
    if(Notification.permission==="granted") new Notification(`تم إضافة ${newCount} منتجات جديدة اليوم 🎉`);
    else if(Notification.permission!=="denied") Notification.requestPermission().then(p=>{ if(p==="granted") new Notification(`تم إضافة ${newCount} منتجات جديدة اليوم 🎉`); });
  }
}

// البحث في المنتجات
document.getElementById("searchBox").addEventListener("input", function(){
  const keyword=this.value.trim().toLowerCase();
  const filtered=productsData.filter(p=>p.name.toLowerCase().includes(keyword));
  renderProducts(filtered);
});

// عند تحميل الصفحة، عرض محتوى السلة
updateCartCount();
</script>
