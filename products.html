<script defer>
const SCRIPT_PRODUCTS_URL = "https://script.google.com/macros/s/AKfycbxW3_pcjSfffMTLZefZpzFIrbhijiaWY_u_4ZAmXEV2O04SMN5zplucKnAugWWbP8zzmA/exec";
const container = document.getElementById("products-container");
let productsData = [];
let cart = JSON.parse(localStorage.getItem("cart")) || [];

// Ø­ÙØ¸ Ø§Ù„Ø³Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
function saveCart() {
  localStorage.setItem("cart", JSON.stringify(cart));
}

// Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
function renderProducts(data){
  let html = "";
  for(let i=0;i<data.length;i++){
      const item = data[i];
      html += `<div class="product">
                  <img src="${item.image || 'https://via.placeholder.com/150'}">
                  <div class="product-info">
                    <div class="name">${item.name}</div>
                    <div class="price">${item.price} Ø¬Ù†ÙŠÙ‡</div>
                    <input type="number" min="1" value="1" data-index="${i}">
                    <button onclick="addToCart(${i})">Ø£Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©</button>
                  </div>
               </div>`;
  }
  container.innerHTML = html;
}

// ØªØ­Ù…ÙŠÙ„ Ø³Ø±ÙŠØ¹ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª
(async function(){
   if(localStorage.getItem("products")){
      productsData = JSON.parse(localStorage.getItem("products"));
      renderProducts(productsData);
   }
   try {
     const res = await fetch(SCRIPT_PRODUCTS_URL, {cache:"no-store"});
     const data = await res.json();
     productsData = data.reverse();
     localStorage.setItem("products", JSON.stringify(productsData));
     renderProducts(productsData);
     setTimeout(checkNewProducts, 1500);
   } catch(err){ console.log("âŒ Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:",err); }
})();

function showToast(msg){
  const toast = document.getElementById("toast");
  toast.innerText = msg;
  toast.style.display = "block";
  setTimeout(()=>toast.style.display="none",1200);
}

// ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ù„Ø© ÙˆÙˆØ¶Ø¹Ù‡ ÙÙˆÙ‚ Ø§Ù„Ø²Ø±
function updateCartCount(){
  const count = cart.reduce((sum, qty)=> qty ? sum+qty : sum, 0);
  const badge = document.getElementById("cart-count");
  badge.style.display = count>0?"inline-block":"none";
  badge.innerText = count;
}

// Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ù„Ù„Ø³Ù„Ø©
function addToCart(index){
  const input = container.querySelector(`input[data-index='${index}']`);
  const quantity = parseInt(input.value);
  if(quantity<=0) return;
  cart[index] = (cart[index] || 0) + quantity;
  updateCartCount();
  saveCart();
  showToast(`${productsData[index].name} ØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡/ØªØ­Ø¯ÙŠØ«Ù‡ ÙÙŠ Ø§Ù„Ø³Ù„Ø©`);
}

// Ø¹Ø±Ø¶ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
function showTotal(){
  let total=0;
  const cartList=document.getElementById("cartList");
  cartList.innerHTML="";
  cart.forEach((qty,idx)=>{
    if(qty){
      const price = productsData[idx].price;
      const lineTotal = qty*price;
      total+=lineTotal;
      const div=document.createElement("div");
      div.className="cart-item";
      div.innerHTML=`<span>${productsData[idx].name}</span>
                     <span>Ø§Ù„ÙƒÙ…ÙŠØ©: <input type="number" min="1" value="${qty}" style="width:50px;" onchange="updateQty(${idx},this.value)"></span>
                     <span>Ø§Ù„Ø³Ø¹Ø±: ${price}</span>
                     <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${lineTotal}</span>
                     <span><button class="remove-btn" onclick="removeItem(${idx})">Ø­Ø°Ù</button></span>`;
      cartList.appendChild(div);
    }
  });
  document.getElementById("totalAmount").innerText=total;
  document.getElementById("totalModal").style.display="block";
}

// ØªØ­Ø¯ÙŠØ« ÙƒÙ…ÙŠØ© Ø¹Ù†ØµØ± ÙÙŠ Ø§Ù„Ø³Ù„Ø©
function updateQty(idx,value){ 
  value=parseInt(value); 
  if(value<=0) delete cart[idx]; 
  else cart[idx]=value; 
  updateCartCount(); 
  saveCart();
  showTotal(); 
}

// Ø¥Ø²Ø§Ù„Ø© Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ø³Ù„Ø©
function removeItem(idx){ 
  delete cart[idx]; 
  updateCartCount(); 
  saveCart();
  showTotal(); 
}

function closeTotalModal(){ document.getElementById("totalModal").style.display='none'; }

// Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
document.getElementById("sendBtn").onclick = function(){
  const orderDiv = document.getElementById("orderNumbers");
  orderDiv.style.display="block";
  orderDiv.querySelectorAll("a").forEach(a=>{
    a.onclick=(e)=>{
      e.preventDefault();
      let text="ğŸ§¾ Ø·Ù„Ø¨ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©\n\n";
      let total=0;
      cart.forEach((qty,idx)=>{
        if(qty){
          const price=productsData[idx].price;
          const lineTotal=qty*price;
          total+=lineTotal;
          text+=`${productsData[idx].name} | ${qty} | ${price} | ${lineTotal}\n`;
        }
      });
      text+=`Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ: ${total} Ø¬Ù†ÙŠÙ‡`;
      window.open(`${a.href}?text=${encodeURIComponent(text)}`,"_blank");
    }
  });
}

document.getElementById("cartBtn").onclick=showTotal;
document.getElementById("totalBtn").onclick=showTotal;
document.getElementById("supportBtn").onclick=()=>window.open("https://wa.me/201022495795","_blank");

// ÙØ­Øµ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
function checkNewProducts(){
  const today=(new Date()).toISOString().split("T")[0];
  let newCount=0;
  productsData.forEach(p=>{ if(p.date&&p.date.startsWith(today)) newCount++; });
  if(newCount>0){
    document.getElementById("notif-count").innerText=newCount;
    document.getElementById("notif-count").style.display="inline-block";
    document.getElementById("newBanner").style.display="block";
    let audio=new Audio("https://www.soundjay.com/buttons/sounds/button-3.mp3"); audio.play();
    if(Notification.permission==="granted") new Notification(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${newCount} Ù…Ù†ØªØ¬Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„ÙŠÙˆÙ… ğŸ‰`);
    else if(Notification.permission!=="denied") Notification.requestPermission().then(p=>{ if(p==="granted") new Notification(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${newCount} Ù…Ù†ØªØ¬Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø§Ù„ÙŠÙˆÙ… ğŸ‰`); });
  }
}

// Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
document.getElementById("searchBox").addEventListener("input", function(){
  const keyword=this.value.trim().toLowerCase();
  const filtered=productsData.filter(p=>p.name.toLowerCase().includes(keyword));
  renderProducts(filtered);
});

// Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©ØŒ Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ù„Ø©
updateCartCount();
</script>
